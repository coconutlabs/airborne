{"version":3,"sources":["app/apis/coordinates.js","app/apis/flight_data.js","app/initialize.js","app/objects/flight.js","app/objects/flight_marker.js","app/objects/map.js"],"names":["superagent","require","jsonp","getFromIp","callback","get","use","end","error","response","body","latitude","longitude","lat","long","module","exports","openSkyApiUrl","getAll","document","addEventListener","_","moment","leaflet","FlightData","AirborneMap","AirborneFlight","AirborneFlightMarker","appMap","flightLayer","FeatureGroup","addLayer","plottedFlights","plotFlights","dataTimestamp","unix","time","format","console","log","states","length","plotCount","i","flight","plottedFlight","icao24","isPlottable","onGround","removeLayer","marker","cleanUpOldData","setTimeout","timeCutoff","subtract","each","data","identifier","timePosition","stateVector","callsign","origin_country","time_position","time_velocity","altitude","on_ground","velocity","heading","vertical_rate","sensors","trim","originCountry","timeVelocity","verticalRate","airplaneIcon","altitudeFt","altitudeLevel","icon","iconUrl","iconSize","iconAnchor","popupAnchor","tooltipHtml","unit","flightIdentifier","speed","Math","round","kph","mph","altitudeM","title","rotationAngle","rotationOrigin","bindTooltip","Marker","coordinates","cartoLightServer","url","attribution","tileLayerForServer","tileServer","TileLayer","minZoom","maxZoom","domElement","invalidateSize","location","LatLng","setView","Map"],"mappings":"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","file":"public/js/app.js","sourcesContent":["const superagent = require('superagent')\nconst jsonp = require('superagent-jsonp')\n\nconst getFromIp = (callback) => {\n  superagent.get('//freegeoip.net/json')\n  .use(jsonp)\n  .end((error, response) => {\n    if (!response) { return callback({ error }) }\n\n    const { body: { latitude, longitude } } = response\n\n    callback({ lat: latitude, long: longitude })\n  })\n}\n\nmodule.exports = {\n  getFromIp\n}\n","const superagent = require('superagent')\n\nconst openSkyApiUrl = 'https://cors-anywhere.herokuapp.com/opensky-network.org/api'\n\nconst getAll = (callback) =>\n  superagent.get(`${openSkyApiUrl}/states/all`)\n  .end((error, response) => {\n    callback(response.body)\n  })\n\nmodule.exports = {\n  getAll\n}\n","document.addEventListener('DOMContentLoaded', () => {\n\tconst _ = require('lodash')\n\tconst moment = require('moment')\n\tconst leaflet = require('leaflet')\n\n\tconst FlightData = require('./apis/flight_data')\n\n\tconst AirborneMap = require('./objects/map')\n\tconst AirborneFlight = require('./objects/flight')\n\tconst AirborneFlightMarker = require('./objects/flight_marker')\n\n\tconst appMap = new AirborneMap('app-map')\n\n\tlet flightLayer = new leaflet.FeatureGroup()\n\tappMap.addLayer(flightLayer)\n\n\tconst plottedFlights = {}\n\n\tconst plotFlights = () => {\n\t\tFlightData.getAll((response) => {\n\t\t\tconst dataTimestamp = moment.unix(response.time).format()\n\t\t\tconsole.log(`${response.states.length} flights updated ${dataTimestamp}`)\n\n\t\t\tlet plotCount = 0\n\n\t\t\tfor (let i = 0; i < response.states.length; i++) {\n\t\t\t\tlet flight = new AirborneFlight(response.states[i])\n\t\t\t\tlet plottedFlight = plottedFlights[flight.icao24]\n\n\t\t\t\tif (!flight.isPlottable || flight.onGround) {\n\t\t\t\t\tif (plottedFlight) {\n\t\t\t\t\t\tflightLayer.removeLayer(plottedFlight.marker)\n\t\t\t\t\t\tdelete plottedFlights[flight.icao24]\n\t\t\t\t\t}\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlet marker = new AirborneFlightMarker(flight)\n\n\t\t\t\tif (plottedFlight) flightLayer.removeLayer(plottedFlight.marker)\n\t\t\t\tflightLayer.addLayer(marker)\n\n\t\t\t\tplottedFlights[flight.icao24] = { flight, marker }\n\n\t\t\t\tplotCount++\n\t\t\t}\n\n\t\t\tconsole.log(`Plotted ${plotCount} flights`);\n\n\t\t\tcleanUpOldData()\n\n\t\t\tsetTimeout(plotFlights, 10000)\n\t\t})\n\t}\n\n\tconst cleanUpOldData = () => {\n\t\tconst timeCutoff = moment().subtract(5, 'minutes').unix()\n\n\t\t_.each(plottedFlights, (data, identifier) => {\n\t\t\tconst { flight } = data\n\t\t\tif (flight.timePosition < timeCutoff) { delete plottedFlights[identifier] }\n\t\t})\n\t}\n\n\tplotFlights()\n});\n","module.exports = class Flight {\n  constructor(stateVector) {\n    // See https://opensky-network.org/apidoc/rest.html#response\n    const [\n      icao24,\n      callsign,\n      origin_country,\n      time_position,\n      time_velocity,\n      longitude,\n      latitude,\n      altitude,\n      on_ground,\n      velocity,\n      heading,\n      vertical_rate,\n      sensors\n    ] = stateVector\n\n    this.icao24 = icao24 // string\n    this.callsign = (callsign ? callsign.trim() : null) // string\n    this.originCountry = origin_country // string\n    this.timePosition = time_position // unix timestamp (seconds)\n    this.timeVelocity = time_velocity // unix timestamp (seconds)\n    this.longitude = longitude // float\n    this.latitude = latitude // float\n    this.altitude = altitude // int (meters)\n    this.onGround = on_ground // boolean\n    this.velocity = velocity // (meters/second)\n    this.heading = heading // float\n    this.verticalRate = vertical_rate // (meters/second)\n    this.sensors = sensors // array of ids\n  }\n\n  get altitudeFt() { return this.altitude * 3.28084 }\n  get altitudeM() { return this.altitude }\n\n  get mph() { return this.velocity * 2.23694 }\n  get kph() { return this.velocity * 3.6 }\n\n  get verticalFps() { return this.verticalRate * 3.28084 }\n  get verticalMps() { return this.verticalRate }\n\n  get isPlottable() { return this.longitude && this.latitude }\n}\n","const leaflet = require('leaflet')\nrequire('leaflet-rotatedmarker')\n\nconst airplaneIcon = (flight) => {\n  const altitude = flight.altitudeFt\n  let altitudeLevel\n\n  switch (true) {\n    case altitude >= 35000:\n      altitudeLevel = 'high'\n      break;\n    case altitude >= 20000:\n      altitudeLevel = 'medium'\n      break;\n    case altitude < 20000:\n      altitudeLevel = 'low'\n      break;\n    default:\n      altitudeLevel = 'default'\n  }\n\n  return leaflet.icon({\n    iconUrl: `./img/airplane-${altitudeLevel}.svg`,\n    iconSize: [20, 20],\n    iconAnchor: [10, 10],\n    popupAnchor: [0, -5]\n  })\n}\n\nconst tooltipHtml = (flight, unit) => {\n  let flightIdentifier, speed, altitude\n\n  flightIdentifier =\n    flight.callsign ?\n    `Flight ${flight.callsign}` :\n    'Unidentified Flight'\n  speed =\n    unit == 'metric' ?\n    `${Math.round(flight.kph)} kph` :\n    `${Math.round(flight.mph)} mph`\n  altitude =\n    unit == 'metric' ?\n    `${Math.round(flight.altitudeM)} m` :\n    `${Math.round(flight.altitudeFt)} ft`\n\n  return `<strong>${flightIdentifier}</strong><br />` +\n  `Speed: <strong>${speed}</strong><br />` +\n  `Altitude: <strong>${altitude}</strong>`\n}\n\nmodule.exports = class AirborneFlightMarker extends leaflet.Marker {\n  constructor(flight) {\n    super([ flight.latitude, flight.longitude ], {\n      icon: airplaneIcon(flight),\n      title: flight.callsign,\n      rotationAngle: Math.round(flight.heading),\n      rotationOrigin: 'center center'\n    })\n    .bindTooltip(tooltipHtml(flight))\n\n    this.flight = flight\n  }\n}\n","const leaflet = require('leaflet')\nconst coordinates = require('../apis/coordinates')\n\nconst cartoLightServer = {\n  url: '//cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}@2x.png',\n  attribution:\n    '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>, ' +\n    '&copy; <a href=\"https://carto.com/attribution\">CARTO</a>'\n}\n\nconst tileLayerForServer = (tileServer) => {\n  const { url, attribution } = tileServer\n\n  return new leaflet.TileLayer(url, { minZoom: 4, maxZoom: 12, attribution })\n}\n\nmodule.exports = class AirborneMap extends leaflet.Map {\n  constructor(domElement) {\n    super(domElement)\n\n    this.addLayer(tileLayerForServer(cartoLightServer))\n    setTimeout(() => { this.invalidateSize() }, 0)\n\n    coordinates.getFromIp((coordinates) => {\n      const { lat, long } = coordinates\n      let location\n\n      if (!lat || !long) {\n        location = new leaflet.LatLng(39.8333333, -98.585522) // US Center\n      } else {\n        location = new leaflet.LatLng(lat, long)\n      }\n\n      this.setView(location, 6)\n    })\n  }\n}\n"]}